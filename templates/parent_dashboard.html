<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent Dashboard - Move2Earn</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .header-left h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header-left p {
            color: #aaa;
            font-size: 14px;
        }
        
        .header-right {
            display: flex;
            gap: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #00d4ff 0%, #00ff88 100%);
            color: #000;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.4);
        }
        
        .btn-logout {
            background: #ff6b6b;
            color: white;
            padding: 8px 16px;
            font-size: 13px;
        }
        
        .btn-logout:hover {
            background: #ee5a52;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.03);
            padding: 10px;
            border-radius: 12px;
            overflow-x: auto;
        }

        .tab-btn {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid transparent;
            color: #aaa;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab-btn:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.05);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2) 0%, rgba(0, 255, 136, 0.2) 100%);
            border: 1px solid rgba(0, 212, 255, 0.3);
            color: #00d4ff;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        .card {
            background: rgba(50, 50, 80, 0.4);
            border: 1px solid rgba(100, 100, 150, 0.3);
            border-radius: 12px;
            padding: 25px;
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }
        
        .card h2 {
            font-size: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #fff;
        }
        
        /* Add Child Form */
        .add-child-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 20px;
            background: rgba(100, 100, 150, 0.2);
            border-radius: 8px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            padding: 10px 12px;
            background: rgba(100, 100, 120, 0.4);
            border: 1px solid rgba(150, 150, 180, 0.3);
            border-radius: 6px;
            color: #fff;
            font-size: 13px;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #00d4ff;
            background: rgba(100, 100, 120, 0.6);
            box-shadow: 0 0 8px rgba(0, 212, 255, 0.2);
        }
        
        .add-child-submit {
            grid-column: 1 / -1;
            padding: 12px;
            background: linear-gradient(135deg, #00d4ff 0%, #00ff88 100%);
            border: none;
            border-radius: 6px;
            color: #000;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        /* Child Cards */
        .children-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }
        
        .child-card {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(100, 0, 255, 0.1) 100%);
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .child-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
            color: #00d4ff;
        }
        
        .child-email {
            font-size: 12px;
            color: #999;
            margin-bottom: 15px;
        }

        /* Template Grid */
        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .template-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .template-card:hover {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.1);
            transform: translateY(-2px);
        }

        .template-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .template-name {
            font-weight: 700;
            color: #fff;
            margin-bottom: 5px;
        }

        .template-desc {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .template-reward {
            font-size: 12px;
            font-weight: 600;
            color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .bonus-btn {
            padding: 8px 12px;
            background: linear-gradient(135deg, #00ff88 0%, #00d4ff 100%);
            border: none;
            border-radius: 4px;
            color: #000;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .bonus-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal-content {
            background: #1a1a2e;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            padding: 25px;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #aaa;
            font-size: 24px;
            cursor: pointer;
        }

        /* Notification */
        .notification-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #00d4ff 0%, #00ff88 100%);
            color: #000;
            padding: 20px;
            border-radius: 12px;
            z-index: 2000;
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }
        
        .notification-popup.show {
            transform: translateX(0);
        }

        /* Mobile */
        @media (max-width: 768px) {
            .add-child-form {
                grid-template-columns: 1fr;
            }
            header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            .header-right {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-left">
            <h1>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Parent Dashboard</h1>
            <p>Welcome back, {{ parent_name }}!</p>
        </div>
        <div class="header-right">
            <button class="btn btn-primary" onclick="openAccountModal()">Account</button>
            <a href="/logout" class="btn btn-logout">Logout</a>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('children')">Children & Overview</button>
        <button class="tab-btn" onclick="switchTab('challenges')">üèÜ Challenges & Rewards</button>
        <button class="tab-btn" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
    </div>

    <!-- TAB 1: Children Overview -->
    <div id="tab-children" class="tab-content active">
        <div class="dashboard-grid">
            
            <!-- Pending Requests (Notifications) -->
            <div class="card" id="approvals-card">
                <h2>üîî Approvals & Requests</h2>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:15px;">
                    <div>
                        <h4 style="margin-bottom:10px; color:#aaa;">Friend Requests</h4>
                        <div id="friendApprovalsList" style="max-height:150px; overflow-y:auto; background:rgba(0,0,0,0.2); padding:10px; border-radius:6px;">
                            Loading...
                        </div>
                    </div>
                    <div>
                        <h4 style="margin-bottom:10px; color:#aaa;">Challenge Unlocks</h4>
                        <div id="challengeApprovalsList" style="max-height:150px; overflow-y:auto; background:rgba(0,0,0,0.2); padding:10px; border-radius:6px;">
                            Loading...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Children List -->
            <div class="card">
                <h2>üë• Your Children</h2>
                {% if children|length > 0 %}
                <div class="children-grid">
                    {% for child in children %}
                    <div class="child-card" data-child-id="{{ child.id }}">
                        <div style="display:flex; justify-content:space-between; align-items:start;">
                            <div>
                                <div class="child-name">{{ child.name }}</div>
                                <div class="child-email">{{ child.email }}</div>
                            </div>
                            <button class="bonus-btn" style="background:#ff6b6b; padding:4px 8px; font-size:11px;" onclick="deleteChild('{{child.id}}', '{{child.name}}')">Remove</button>
                        </div>
                        
                        <!-- Timer Section -->
                        <div class="bonus-section">
                            <div style="font-size:12px; color:#aaa; margin-bottom:8px;">‚è±Ô∏è TIMER</div>
                            <div style="background:rgba(0,212,255,0.1); padding:12px; border-radius:6px; margin-bottom:10px; border:1px solid rgba(0,212,255,0.2);">
                                <div style="font-size:24px; font-weight:700; color:#00d4ff; text-align:center; margin-bottom:10px; font-family:monospace;" class="timer-display">00:00</div>
                                <div style="display:flex; gap:8px;">
                                    <button class="bonus-btn timer-start-btn" style="flex:1; background:linear-gradient(135deg, #00ff88 0%, #00d4ff 100%); padding:6px;" onclick="startTimer('{{child.id}}')">START</button>
                                    <button class="bonus-btn timer-stop-btn" style="flex:1; background:#ff6b6b; padding:6px; display:none;" onclick="stopTimer('{{child.id}}')">STOP</button>
                                </div>
                            </div>
                        </div>

                        <!-- Time Used Display -->
                        <div class="bonus-section">
                            <div style="font-size:12px; color:#aaa; margin-bottom:5px;">üìä TIME USED TODAY</div>
                            <div style="background:rgba(255,200,0,0.1); padding:10px; border-radius:6px; border:1px solid rgba(255,200,0,0.2); text-align:center;">
                                <div style="font-size:18px; font-weight:700; color:#ffcc00;" class="time-used-display">0m</div>
                                <div style="font-size:11px; color:#aaa; margin-top:3px;">of {{ child.daily_screen_time_limit }}m daily limit</div>
                            </div>
                        </div>
                        
                        <div class="bonus-section">
                            <div style="font-size:12px; color:#aaa; margin-bottom:5px;">DAILY LIMIT</div>
                            <div style="display:flex; gap:10px;">
                                <input type="number" class="daily-limit" value="{{ child.daily_screen_time_limit }}" style="width:80px; padding:6px; border-radius:4px; border:none;">
                                <button class="bonus-btn update-limits">Update</button>
                            </div>
                        </div>

                        <div class="bonus-section">
                            <div style="font-size:12px; color:#aaa; margin-bottom:5px;">GRANT BONUS TIME</div>
                            <div style="display:flex; gap:10px; margin-bottom:5px;">
                                <input type="number" class="bonus-minutes" placeholder="Min" style="width:80px; padding:6px; border-radius:4px; border:none;">
                                <button class="bonus-btn add-bonus">Send</button>
                            </div>
                            <textarea class="bonus-message" placeholder="Message..." style="width:100%; height:40px; padding:5px; font-size:12px; border-radius:4px; border:none;"></textarea>
                        </div>

                        <!-- Friends Section -->
                        <div class="bonus-section">
                            <div style="font-size:12px; color:#aaa; margin-bottom:8px;">üë• FRIENDS</div>
                            <div id="child-friends-{{child.id}}" style="background:rgba(100,200,255,0.1); padding:10px; border-radius:6px; border:1px solid rgba(100,200,255,0.2); max-height:150px; overflow-y:auto;">
                                <div style="font-size:11px; color:#aaa; text-align:center;">Loading friends...</div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div style="text-align:center; padding:30px; color:#aaa;">No children added yet.</div>
                {% endif %}
            </div>

            <!-- Add Child -->
            <div class="card">
                <h2>‚ûï Add a Child Account</h2>
                <div id="addChildMsg" style="margin-bottom:10px;"></div>
                <form class="add-child-form" id="addChildForm">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="c_name" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="c_email" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="c_pass" required>
                    </div>
                    <div class="form-group">
                        <label>Confirm Password</label>
                        <input type="password" id="c_pass2" required>
                    </div>
                    <button type="submit" class="add-child-submit">Create Account</button>
                </form>
            </div>
        </div>
    </div>

    <!-- TAB 2: Challenges -->
    <div id="tab-challenges" class="tab-content">
        <div class="card">
            <h2>üèÜ Create Challenges</h2>
            <p style="color:#aaa; margin-bottom:20px;">Choose a fun template or create your own custom challenge to motivate your kids!</p>
            
            <h3 style="margin-bottom:15px; font-size:16px; color:#00ff88;">‚ú® Wacky Templates</h3>
            
            <div style="background:rgba(0,212,255,0.1); border:1px solid rgba(0,212,255,0.2); border-radius:10px; padding:15px; margin-bottom:25px; font-size:13px;">
                <h4 style="margin:0 0 10px 0; color:#00d4ff; font-size:14px;">üí° How Rewards Work</h4>
                <ul style="margin:0; padding-left:20px; line-height:1.6; color:#ddd;">
                    <li><strong>Fixed Minutes:</strong> A specific amount of screen time (e.g., 30 min) added to the child's daily limit once they complete the challenge.</li>
                    <li><strong>% Boost:</strong> A percentage-based reward calculated from their <em>existing daily limit</em>. For example, if their limit is 180 min, a 10% boost grants 18 extra minutes. This is great for scaling rewards to the child's typical usage!</li>
                </ul>
            </div>
            <div id="templates-list" class="templates-grid">
                <!-- Loaded via JS -->
                Loading templates...
            </div>

            <h3 style="margin-bottom:15px; font-size:16px; color:#00d4ff;">üõ†Ô∏è Custom Challenge</h3>
            <form id="customChallengeForm" style="background:rgba(0,0,0,0.2); padding:20px; border-radius:10px;">
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px;">
                    <div class="form-group">
                        <label>Challenge Name</label>
                        <input type="text" id="cust_name" placeholder="e.g. Clean Room" required>
                    </div>
                    <div class="form-group">
                        <label>Reward Value</label>
                        <div style="display:flex; gap:10px;">
                            <input type="number" id="cust_reward" value="30" style="flex:1;" required>
                            <select id="cust_reward_type" style="width:120px; color:#000; border-radius:4px;">
                                <option value="fixed">Minutes</option>
                                <option value="percentage">% Boost</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Description</label>
                        <input type="text" id="cust_desc" placeholder="What needs to be done?" required>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Assign To</label>
                        <div id="cust_children_select" style="display:flex; gap:10px; flex-wrap:wrap;">
                            {% for child in children %}
                            <label style="background:rgba(255,255,255,0.1); padding:5px 10px; border-radius:20px; cursor:pointer;">
                                <input type="checkbox" value="{{child.id}}" class="assign-checkbox"> {{child.name}}
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <button type="submit" class="bonus-btn" style="margin-top:15px; width:100%;">Create & Assign Challenge</button>
                <div id="custMsg" style="margin-top:10px;"></div>
            </form>
        </div>
    </div>

    <!-- TAB 3: Settings -->
    <div id="tab-settings" class="tab-content">
        <div class="card">
            <h2>üî• Streak Settings</h2>
            <p style="color:#aaa; margin-bottom:20px;">Configure how much bonus time children earn for daily activity streaks.</p>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px;">
                <div class="form-group">
                    <label>Base Bonus (Minutes)</label>
                    <input type="number" id="stk_base" value="5">
                </div>
                <div class="form-group">
                    <label>Daily Increment (Minutes)</label>
                    <input type="number" id="stk_inc" value="2">
                </div>
                <div class="form-group">
                    <label>Max Daily Cap (Minutes)</label>
                    <input type="number" id="stk_cap" value="60">
                </div>
            </div>
            <button id="saveStreakBtn" class="bonus-btn" style="margin-top:20px;">Save Changes</button>
            <div id="streakMsg" style="margin-top:10px;"></div>
        </div>
    </div>

</div>

<!-- Template Activation Modal -->
<div id="templateModal" class="modal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal()">√ó</button>
        <h2 id="modalTitle" style="margin-bottom:10px;">Activate Challenge</h2>
        <p id="modalDesc" style="color:#aaa; margin-bottom:20px;"></p>
        
        <form id="activateTemplateForm">
            <input type="hidden" id="tpl_id_meta">
            <div class="form-group" style="margin-bottom:15px;">
                <label>Customize Reward</label>
    <div style="display:flex; gap:10px;">
                    <input type="number" id="tpl_reward_val" style="flex:1;" required>
                    <select id="tpl_reward_type" style="width:120px; color:#000;">
                        <option value="fixed">Minutes</option>
                        <option value="percentage">% Boost</option>
                    </select>
                </div>
                <small style="color:#666; font-size:11px; margin-top:5px;">Adjust the reward amount before activating.</small>
            </div>
            
            <div class="form-group" style="margin-bottom:20px;">
                <label>Assign To</label>
                <div id="tpl_children_select" style="display:flex; flex-wrap:wrap; gap:8px;">
                    {% for child in children %}
                    <label style="background:rgba(255,255,255,0.1); padding:5px 10px; border-radius:20px; cursor:pointer;">
                        <input type="checkbox" value="{{child.id}}" class="tpl-assign-checkbox" checked> {{child.name}}
                    </label>
                    {% endfor %}
                </div>
            </div>
            
            <button type="submit" class="bonus-btn" style="width:100%; font-size:16px; padding:12px;">üöÄ Activate Challenge!</button>
        </form>
    </div>
</div>

<!-- Account Modal (Simple Update) -->
<div id="accountModal" class="modal">
    <div class="modal-content">
        <button class="close-modal" onclick="document.getElementById('accountModal').style.display='none'">√ó</button>
        <h2>Account Settings</h2>
        <form id="acctForm" style="margin-top:15px;">
            <div class="form-group" style="margin-bottom:10px;">
                <label>Name</label>
                <input type="text" id="acc_name" value="{{ parent_name }}">
            </div>
            <div class="form-group" style="margin-bottom:10px;">
                <label>Email</label>
                <input type="email" id="acc_email" value="{{ parent_email }}">
            </div>
            <button type="submit" class="bonus-btn" style="width:100%;">Update Profile</button>
        </form>
    </div>
</div>

<!-- Notification Container -->
<div id="notification-container" style="position:fixed; top:20px; right:20px; z-index:9999;"></div>

<script>
    // --- Tabs Logic ---
    function switchTab(tabId) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // Find button by text roughly or index? Better to pass Event.
        // Simple hack: find button with onclick matching
        const buttons = document.querySelectorAll('.tab-btn');
        if(tabId === 'children') buttons[0].classList.add('active');
        if(tabId === 'challenges') buttons[1].classList.add('active');
        if(tabId === 'settings') buttons[2].classList.add('active');

        document.getElementById('tab-' + tabId).classList.add('active');
    }

    // --- Template Logic ---
    async function loadTemplates() {
        const container = document.getElementById('templates-list');
        try {
            const resp = await fetch('/api/challenge-templates');
            const data = await resp.json();
            
            container.innerHTML = '';
            data.templates.forEach(t => {
                const el = document.createElement('div');
                el.className = 'template-card';
                el.onclick = () => openTemplateModal(t);
                el.innerHTML = `
                    <div class="template-icon">${t.icon}</div>
                    <div class="template-name">${t.name}</div>
                    <div class="template-desc">${t.description}</div>
                    <div class="template-reward">Reward: ${t.reward_value || t.reward_minutes} ${t.reward_type === 'percentage' ? '%' : 'min'}</div>
                `;
                container.appendChild(el);
            });
        } catch (e) {
            container.innerHTML = 'Failed to load templates.';
        }
    }

    function openTemplateModal(t) {
        const m = document.getElementById('templateModal');
        document.getElementById('modalTitle').textContent = t.name;
        document.getElementById('modalDesc').textContent = t.description;
        
        // Setup inputs
        document.getElementById('tpl_id_meta').value = JSON.stringify(t); // Store full obj
        document.getElementById('tpl_reward_val').value = t.reward_value || t.reward_minutes;
        
        m.style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('templateModal').style.display = 'none';
        document.getElementById('accountModal').style.display = 'none';
    }

    // --- Activate Template ---
    document.getElementById('activateTemplateForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const baseTpl = JSON.parse(document.getElementById('tpl_id_meta').value);
        const rewardVal = document.getElementById('tpl_reward_val').value;
        const children = Array.from(document.querySelectorAll('.tpl-assign-checkbox:checked')).map(c => c.value);

        if(children.length === 0) { alert('Select at least one child!'); return; }

        const rType = document.getElementById('tpl_reward_type').value;
        
        const payload = {
            name: baseTpl.name,
            description: baseTpl.description,
            image_url: '',
            task: {}
        };

        if (rType === 'percentage') {
            payload.reward_minutes = 0;
            payload.reward_type = 'percentage';
            payload.reward_value = parseInt(rewardVal);
        } else {
            payload.reward_minutes = parseInt(rewardVal);
            payload.reward_type = 'fixed';
            payload.reward_value = 0;
        }

        // 1. Create Challenge (Duplicate)
        try {
            const createResp = await fetch('/api/admin/challenges', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const createData = await createResp.json();
            
            if(createResp.ok) {
                const newId = createData.challenge_id;
                // 2. Assign
                await fetch(`/api/admin/challenges/${newId}/assign`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ children: children, visible: true })
                });
                
                closeModal();
                showNotification('Challenge Activated!', 'The challenge has been sent to the selected children.');
            }
        } catch(err) {
            alert('Error activating challenge');
        }
    });

    // --- Custom Challenge ---
    document.getElementById('customChallengeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('cust_name').value;
        const reward = document.getElementById('cust_reward').value;
        const rType = document.getElementById('cust_reward_type').value;
        const desc = document.getElementById('cust_desc').value;
        const children = Array.from(document.querySelectorAll('.assign-checkbox:checked')).map(c => c.value);

        if(children.length === 0) { alert('Select children'); return; }

        const payload = {
            name,
            description: desc,
            image_url: '',
            task: {}
        };

        if (rType === 'percentage') {
            payload.reward_minutes = 0;
            payload.reward_type = 'percentage';
            payload.reward_value = parseInt(reward);
        } else {
            payload.reward_minutes = parseInt(reward);
            payload.reward_type = 'fixed';
            payload.reward_value = 0;
        }

        try {
            const resp = await fetch('/api/admin/challenges', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const d = await resp.json();
            if(resp.ok) {
                await fetch(`/api/admin/challenges/${d.challenge_id}/assign`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ children, visible: true })
                });
                document.getElementById('customChallengeForm').reset();
                showNotification('Custom Challenge Created!', 'Sent to children.');
            }
        } catch(e) { alert('Error'); }
    });

    // --- Common Functions ---
    function showNotification(title, body) {
        const c = document.getElementById('notification-container');
        const n = document.createElement('div');
        n.style.background = 'linear-gradient(135deg, #00d4ff 0%, #00ff88 100%)';
        n.style.padding = '15px';
        n.style.borderRadius = '8px';
        n.style.marginBottom = '10px';
        n.style.color = '#000';
        n.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';
        n.innerHTML = `<strong>${title}</strong><br>${body}`;
        c.appendChild(n);
        setTimeout(() => n.remove(), 4000);
    }
    
    function deleteChild(id, name) {
        if(confirm('Delete ' + name + '?')) {
            fetch('/api/delete-child/' + id, { method: 'POST' })
            .then(() => location.reload());
        }
    }

    function openAccountModal() { document.getElementById('accountModal').style.display='flex'; }

    // --- Poll Approvals ---
    async function loadApprovals() {
        // Friend Requests
        try {
            const fr = await fetch('/api/parent-friend-approvals').then(r => r.json());
            const frBox = document.getElementById('friendApprovalsList');
            if(fr.requests && fr.requests.length) {
                frBox.innerHTML = fr.requests.map(r => {
                    // Build approval status details
                    let statusClass = 'status-pending';
                    let statusIcon = '‚è≥';
                    if (r.status_text.includes('All parents')) {
                        statusClass = 'status-approved';
                        statusIcon = '‚úì';
                    }
                    
                    // Build parent approval details
                    let approvalDetails = '';
                    if (r.required_parents && r.required_parents.length > 0) {
                        approvalDetails = r.required_parents.map(p => {
                            const isApproved = r.approved_parents && r.approved_parents.some(ap => ap.id === p.id);
                            return `<div style="font-size:11px; color:${isApproved ? '#00ff88' : '#ffaa00'}; margin:3px 0;">
                                ${isApproved ? '‚úì' : '‚è≥'} ${p.name}${isApproved ? ' (approved)' : ''}
                            </div>`;
                        }).join('');
                    }
                    
                    return `
                    <div style="background:rgba(255,255,255,0.05); padding:8px; margin-bottom:8px; border-radius:4px; border-left:3px solid ${statusClass === 'status-approved' ? '#00ff88' : '#ffaa00'};">
                        <div style="font-weight:bold; margin-bottom:3px;">
                            <span style="color:#00ff88;">${r.from_name || 'Child'}</span> ‚ûî 
                            <span style="color:#00ff88;">${r.to_name || 'Child'}</span>
                        </div>
                        <div style="font-size:12px; color:#aaa; margin-bottom:5px;">
                            ${statusIcon} <span style="color:#ccc;">${r.status_text}</span>
                        </div>
                        ${approvalDetails ? `<div style="margin-bottom:5px;">${approvalDetails}</div>` : ''}
                        <div style="display:flex; gap:5px;">
                            <button class="bonus-btn" style="padding:2px 8px; font-size:11px;" onclick="respondFriend('${r.id}', 'approve')">Approve</button>
                            <button class="bonus-btn" style="background:#ff6b6b; padding:2px 8px; font-size:11px;" onclick="respondFriend('${r.id}', 'reject')">Reject</button>
                        </div>
                    </div>
                `}).join('');
            } else { frBox.innerHTML = '<div style="color:#aaa; font-size:12px;">No pending requests</div>'; }
        } catch(e){}

        // Challenge Requests
        try {
            const cr = await fetch('/api/parent-challenge-approvals').then(r => r.json());
            const crBox = document.getElementById('challengeApprovalsList');
            if(cr.requests && cr.requests.length) {
                crBox.innerHTML = cr.requests.map(r => `
                     <div style="background:rgba(255,255,255,0.05); padding:8px; margin-bottom:5px; border-radius:4px; font-size:12px;">
                        <span style="color:#ffc107;">${r.child_name || 'Child'}</span> wants to unlock challenge.
                        <div style="margin-top:5px; display:flex; gap:5px;">
                            <button class="bonus-btn" style="padding:2px 8px;" onclick="respondChal('${r.id}', 'approve')">Approve</button>
                            <button class="bonus-btn" style="background:#ff6b6b; padding:2px 8px;" onclick="respondChal('${r.id}', 'reject')">Reject</button>
                        </div>
                    </div>
                `).join('');
            } else { crBox.innerHTML = '<div style="color:#aaa; font-size:12px;">No pending requests</div>'; }
        } catch(e){}
    }

    async function respondFriend(id, act) {
        await fetch('/api/respond-friend-request', {
             method:'POST', headers:{'Content-Type':'application/json'},
             body: JSON.stringify({request_id: id, action: act})
        });
        loadApprovals();
    }

    async function respondChal(id, act) {
        await fetch('/api/respond-challenge-unlock', {
             method:'POST', headers:{'Content-Type':'application/json'},
             body: JSON.stringify({request_id: id, action: act})
        });
        loadApprovals();
    }

    // --- Init ---
    loadTemplates();
    loadApprovals();
    setInterval(loadApprovals, 10000);

    // Auto-update child cards every 3 seconds for real-time timer display
    setInterval(() => {
        document.querySelectorAll('.child-card').forEach(card => {
            const childId = card.dataset.childId;
            if(!activeTimers[childId]) {
                loadChildTimeUsed(childId);
            }
        });
    }, 3000);


    // --- Restored Logic for Core Actions ---

    // 1. Add Child
    document.getElementById('addChildForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const msg = document.getElementById('addChildMsg');
        const name = document.getElementById('c_name').value;
        const email = document.getElementById('c_email').value;
        const p1 = document.getElementById('c_pass').value;
        const p2 = document.getElementById('c_pass2').value;

        if(p1 !== p2) { msg.textContent = 'Passwords do not match'; return; }

        try {
            const resp = await fetch('/api/add-child', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ child_name: name, child_email: email, child_password: p1 })
            });
            const d = await resp.json();
            if(resp.ok) {
                msg.textContent = 'Success! Reloading...';
                setTimeout(() => location.reload(), 1500);
            } else {
                msg.textContent = d.error || 'Failed';
            }
        } catch(err) { msg.textContent = 'Error'; }
    });

    // 2. Update Limits
    document.querySelectorAll('.update-limits').forEach(btn => {
        btn.addEventListener('click', async function() {
            const card = this.closest('.child-card');
            const id = card.dataset.childId;
            const val = card.querySelector('.daily-limit').value;
            try {
                const resp = await fetch(`/api/update-child-limits/${id}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ daily_limit: parseInt(val) })
                });
                if(resp.ok) {
                    this.textContent = '‚úì Saved';
                    setTimeout(() => this.textContent = 'Update', 2000);
                }
            } catch(e) {}
        });
    });

    // 3. Add Bonus
    document.querySelectorAll('.add-bonus').forEach(btn => {
        btn.addEventListener('click', async function() {
            const card = this.closest('.child-card');
            const id = card.dataset.childId;
            const mins = card.querySelector('.bonus-minutes').value;
            const msg = card.querySelector('.bonus-message').value;
            
            if(!mins) return;
            
            try {
                this.textContent = '...';
                const resp = await fetch(`/api/add-earned-time/${id}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ minutes: parseInt(mins), message: msg })
                });
                if(resp.ok) {
                    this.textContent = '‚úì Sent';
                    card.querySelector('.bonus-minutes').value = '';
                    card.querySelector('.bonus-message').value = '';
                    setTimeout(() => this.textContent = 'Send', 2000);
                }
            } catch(e) {}
        });
    });

    // 4. Save Streak Settings
    document.getElementById('saveStreakBtn').addEventListener('click', async function() {
        const base = document.getElementById('stk_base').value;
        const inc = document.getElementById('stk_inc').value;
        const cap = document.getElementById('stk_cap').value;
        const msg = document.getElementById('streakMsg');
        
        try {
            const resp = await fetch('/api/set-streak-settings', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    base_minutes: parseInt(base), 
                    increment_minutes: parseInt(inc), 
                    cap_minutes: parseInt(cap) 
                })
            });
            if(resp.ok) msg.textContent = 'Settings saved!';
            else msg.textContent = 'Error saving settings';
        } catch(e) { msg.textContent = 'Error'; }
    });
    
    // 5. Account Settings (Simple)
    document.getElementById('acctForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        // Implement /api/update-account call
        const name = document.getElementById('acc_name').value;
        const email = document.getElementById('acc_email').value;
        await fetch('/api/update-account', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name, email })
        });
        location.reload();
    });

    // --- Timer Control Functions ---
    // Track active timers per child
    const activeTimers = {};
    const timerStartTimes = {};

    async function startTimer(childId) {
        try {
            const resp = await fetch(`/api/control-timer/${childId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'start' })
            });
            if(resp.ok) {
                // Start local timer display
                timerStartTimes[childId] = Date.now();
                activeTimers[childId] = true;
                updateTimerUI(childId);
                // Update UI buttons
                const card = document.querySelector(`[data-child-id="${childId}"]`);
                card.querySelector('.timer-start-btn').style.display = 'none';
                card.querySelector('.timer-stop-btn').style.display = 'block';
            }
        } catch(e) {
            console.error('Failed to start timer:', e);
        }
    }

    async function stopTimer(childId) {
        try {
            const resp = await fetch(`/api/control-timer/${childId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'stop' })
            });
            if(resp.ok) {
                const data = await resp.json();
                // Stop local timer
                activeTimers[childId] = false;
                delete timerStartTimes[childId];
                
                // Update UI buttons
                const card = document.querySelector(`[data-child-id="${childId}"]`);
                card.querySelector('.timer-start-btn').style.display = 'block';
                card.querySelector('.timer-stop-btn').style.display = 'none';
                
                // Reset timer display
                card.querySelector('.timer-display').textContent = '00:00';
                
                // Reload time used display
                loadChildTimeUsed(childId);
            }
        } catch(e) {
            console.error('Failed to stop timer:', e);
        }
    }

    function updateTimerUI(childId) {
        const card = document.querySelector(`[data-child-id="${childId}"]`);
        if(!card || !activeTimers[childId]) return;
        
        const startTime = timerStartTimes[childId];
        const elapsedMs = Date.now() - startTime;
        const totalSeconds = Math.floor(elapsedMs / 1000);
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        
        const display = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        card.querySelector('.timer-display').textContent = display;
        
        // Continue updating
        setTimeout(() => updateTimerUI(childId), 1000);
    }

    async function loadChildTimeUsed(childId) {
        try {
            const resp = await fetch(`/api/child-time-used/${childId}`);
            if(resp.ok) {
                const data = await resp.json();
                const card = document.querySelector(`[data-child-id="${childId}"]`);
                const timeUsed = data.time_used || 0;
                // Format to 2 decimal places, but remove trailing zeros for cleaner display
                const formatted = timeUsed.toFixed(2).replace(/\.?0+$/, '');
                card.querySelector('.time-used-display').textContent = `${formatted}m`;
            }
        } catch(e) {
            console.error('Failed to load time used:', e);
        }
    }

    // Function to periodically reload all child data from the server
    async function refreshAllChildrenData() {
        try {
            const resp = await fetch('/api/parent-children');
            if(resp.ok) {
                const data = await resp.json();
                const children = data.children || [];
                
                // Update existing child cards with fresh data
                children.forEach(child => {
                    const card = document.querySelector(`[data-child-id="${child.id}"]`);
                    if(card) {
                        // Update daily limit if changed
                        const limitInput = card.querySelector('.daily-limit');
                        if(limitInput && limitInput.value != child.daily_screen_time_limit) {
                            limitInput.value = child.daily_screen_time_limit;
                        }
                    }
                });
            }
        } catch(e) {
            console.error('Failed to refresh children data:', e);
        }
    }

    async function loadChildFriends(childId) {
        try {
            const resp = await fetch(`/api/child-friends/${childId}`);
            if(resp.ok) {
                const data = await resp.json();
                const friendsBox = document.getElementById(`child-friends-${childId}`);
                const friends = data.friends || [];
                
                if(friends.length === 0) {
                    friendsBox.innerHTML = '<div style="font-size:11px; color:#aaa; text-align:center;">No friends yet</div>';
                } else {
                    friendsBox.innerHTML = friends.map(f => `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:6px; margin-bottom:4px; background:rgba(0,0,0,0.2); border-radius:4px; font-size:11px;">
                            <div>
                                <div style="color:#00d4ff; font-weight:600;">${f.name}</div>
                                <div style="color:#777; font-size:10px;">${f.email}</div>
                            </div>
                            <button class="bonus-btn" style="padding:2px 8px; font-size:10px; background:#ff6b6b;" onclick="removeChildFriend('${childId}', '${f.id}')">Remove</button>
                        </div>
                    `).join('');
                }
            }
        } catch(e) {
            console.error('Failed to load friends:', e);
            const friendsBox = document.getElementById(`child-friends-${childId}`);
            if(friendsBox) friendsBox.innerHTML = '<div style="font-size:11px; color:#ff6b6b;">Error loading friends</div>';
        }
    }

    async function removeChildFriend(childId, friendId) {
        if(!confirm('Remove this friend?')) return;
        try {
            const resp = await fetch('/api/remove-friend', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ child_id: childId, friend_id: friendId })
            });
            if(resp.ok) {
                loadChildFriends(childId);
            } else {
                const err = await resp.json();
                alert('Error: ' + (err.error || 'Failed to remove friend'));
            }
        } catch(e) {
            console.error('Failed to remove friend:', e);
            alert('Error removing friend');
        }
    }

    // Load time used for all children on page load
    document.querySelectorAll('.child-card').forEach(card => {
        const childId = card.dataset.childId;
        loadChildTimeUsed(childId);
        loadChildFriends(childId);
    });

    // Refresh time used every 3 seconds for real-time updates
    setInterval(() => {
        document.querySelectorAll('.child-card').forEach(card => {
            const childId = card.dataset.childId;
            if(!activeTimers[childId]) {
                loadChildTimeUsed(childId);
            }
        });
    }, 3000);

    // Refresh friends every 8 seconds
    setInterval(() => {
        document.querySelectorAll('.child-card').forEach(card => {
            const childId = card.dataset.childId;
            loadChildFriends(childId);
        });
    }, 8000);

    // Refresh all children data periodically to catch any server-side changes
    setInterval(() => {
        refreshAllChildrenData();
    }, 15000);

</script>
</body>
</html>
